(function(e,t){var i=function(t,i){this.options=i,this.$element=e(t),this._create()};i.prototype={constructor:i,marker:function(){return this.gmarker},map:function(){return this.gmap},updatePosition:function(){this.gmarker.setVisible(!0),this._updatePosition(this.gmarker.getPosition())},reloadPosition:function(){this.gmarker.setVisible(!0),this.gmarker.setPosition(new t.maps.LatLng(this.lat.val(),this.lng.val())),this.gmap.setCenter(this.gmarker.getPosition())},selected:function(){return this.selectedResult},_create:function(){this.geocoder=new t.maps.Geocoder;var i=this;this.$element.typeahead({minLength:3,delay:1e3,source:this._geocode.bind(this),textproperty:function(e){return e.formatted_address},updater:function(e){return i.$element.trigger("addressChanged",e),this.textproperty(e)},matcher:function(){return!0}}),this.options.map&&(this.$mapElement=e(this.options.map)[0],this._initMap())},_initMap:function(){this.gmap=new t.maps.Map(this.$mapElement,this.options.mapOptions),this.gmarker=new t.maps.Marker({position:this.options.mapOptions.center,map:this.gmap,draggable:this.options.draggableMarker}),t.maps.event.addListener(this.gmarker,"dragend",e.proxy(this._markerMoved,this)),this.gmarker.setVisible(!1),this.$element.on("addressChanged",this._focusAddress.bind(this))},_getAddressByMarkerPosition:function(e,i){var s=this;this.geocoder.geocode({latLng:e},function(e,r){if(r==t.maps.GeocoderStatus.OK){var n=e[0];s.$element.trigger("addressChanged",n),i(n)}})},_markerMoved:function(){var e=this.gmarker.getPosition();e.getAddress=this._getAddressByMarkerPosition.bind(this,e),this.$element.trigger("positionChanged",e)},_geocode:function(e,i){this.geocoder.geocode({address:e+" ",region:this.options.regionBias},function(e,s){if(s==t.maps.GeocoderStatus.OK)for(var r=[],n=0;e.length>n;n++)r.push(e[n]);i(r)})},_findInfo:function(e,t){for(var i=0;e.address_components.length>i;i++){var s=e.address_components[i];if(-1!=s.types.indexOf(t))return s.long_name}return!1},_focusAddress:function(e,t){t&&this.gmarker&&(this.gmarker.setPosition(t.geometry.location),this.gmarker.setVisible(!0),this.gmap.fitBounds(t.geometry.viewport))},_addressSelected:function(e,t){console.dir(t),this.selectedResult=t},_locationSelected:function(){}},e.fn.addresspicker=function(t,s){return this.each(function(){var r=e(this),n=r.data("addresspicker"),o=e.extend(!0,{},e.fn.addresspicker.defaults,r.data(),"object"==typeof t&&t);n||r.data("addresspicker",n=new i(this,o)),"string"==typeof t&&n[t](s)})},e.fn.addresspicker.defaults={draggableMarker:!0,regionBias:null,map:!1,typeaheaddelay:300,mapOptions:{zoom:5,center:new t.maps.LatLng(46,2),scrollwheel:!1,mapTypeId:t.maps.MapTypeId.ROADMAP},onUpdate:function(){}},e.fn.addresspicker.Constructor=i,e.fn.addresspicker.position=function(){return this.selectedResult},Array.indexOf||(Array.prototype.indexOf=function(e){for(var t=0;this.length>t;t++)if(this[t]==e)return t;return-1})})(window.jQuery,window.google);